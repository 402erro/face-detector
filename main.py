import cv2 as cv
import mediapipe as mp
from mediapipe import solutions
from mediapipe.framework.formats import landmark_pb2
"""
1. We need to first receive input from the webcam 
2. OpenCV seems to display the footage reversed so now we need to flip it
3. Detect footage using mp
4. Print mp's results and create an algorithm to detect whether its a left or right hand
"""

Base_options = mp.tasks.BaseOptions
hand_landmarker = mp.tasks.vision.HandLandmarker
hand_landmarker_options = mp.tasks.vision.HandLandmarkerOptions
hand_landmarker_result = mp.tasks.vision.HandLandmarkerResult
vision_running_mode = mp.tasks.vision.RunningMode
model_path = r"C:\Users\rowdh\OneDrive\Documents\Tomfoolery\Personal Project\face-detector\hand_landmarker.task"

# Captures the video from the web cam using opencv
cam = cv.VideoCapture(0)
latest_results = []
def print_result(result: hand_landmarker_result, output_image, timestamp_ms: int):
    latest_results.append(result.handedness)
    return(result)



"""
Results: HandLandmarkerResult(handedness=[[Category(index=0, score=0.8045671582221985, display_name='Right', category_name='Right')]], hand_landmarks=[[NormalizedLandmark(x=0.003295004367828369, y=0.783959686756134, z=4.5667452042152945e-08, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.10128550231456757, y=0.9050168991088867, z=-0.04264538735151291, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.21122394502162933, y=0.8746050000190735, z=-0.056601591408252716, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2947639524936676, y=0.7991200685501099, z=-0.06532158702611923, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.3598313331604004, y=0.7479221224784851, z=-0.07627969235181808, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2292066067457199, y=0.6504019498825073, z=-0.04501312971115112, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2893597483634949, y=0.5059142112731934, z=-0.07476258277893066, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.3243100643157959, y=0.4135318398475647, z=-0.10195986926555634, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.35614702105522156, y=0.3259149193763733, z=-0.12234582006931305, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.18273605406284332, y=0.571935772895813, z=-0.041630204766988754, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.23487290740013123, y=0.40686899423599243, z=-0.06926501542329788, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2716164290904999, y=0.2900274097919464, z=-0.09678776562213898, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.3037058711051941, y=0.1839938759803772, z=-0.11934520304203033, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.1289178431034088, y=0.5391893982887268, z=-0.04204752296209335, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.17592276632785797, y=0.41815677285194397, z=-0.0734848603606224, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2137562334537506, y=0.330605149269104, z=-0.09597206115722656, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.24858209490776062, y=0.2512519359588623, z=-0.11185546219348907, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.07470455765724182, y=0.5424387454986572, z=-0.04531862959265709, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.10781814157962799, y=0.489107608795166, z=-0.07124422490596771, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.13172125816345215, y=0.4487096071243286, z=-0.08113383501768112, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.15486133098602295, y=0.4082055985927582, z=-0.08823477476835251, visibility=0.0, presence=0.0)]], hand_world_landmarks=[[Landmark(x=-0.0570889413356781, y=0.03657514229416847, z=0.038191698491573334, visibility=0.0, presence=0.0), Landmark(x=-0.02434578351676464, y=0.04580717161297798, z=0.02816149778664112, visibility=0.0, presence=0.0), Landmark(x=0.005880526266992092, y=0.04904776066541672, z=0.020098315551877022, visibility=0.0, presence=0.0), Landmark(x=0.03406742960214615, y=0.04572639241814613, z=0.005415365565568209, visibility=0.0, presence=0.0), Landmark(x=0.05834018811583519, y=0.03401524946093559, z=-0.013130648992955685, visibility=0.0, presence=0.0), Landmark(x=0.015267433598637581, y=0.006963309831917286, z=0.008579004555940628, visibility=0.0, presence=0.0), Landmark(x=0.0303836427628994, y=-0.002825495321303606, z=3.528482193360105e-05, visibility=0.0, presence=0.0), Landmark(x=0.047375429421663284, y=-0.01557520404458046, z=-0.006235090550035238, visibility=0.0, presence=0.0), Landmark(x=0.05484665557742119, y=-0.031371671706438065, z=-0.0221878532320261, visibility=0.0, presence=0.0), Landmark(x=0.003682598937302828, y=-0.004578103311359882, z=0.0035771732218563557, visibility=0.0, presence=0.0), Landmark(x=0.020915089175105095, y=-0.020718468353152275, z=-0.004081586375832558, visibility=0.0, presence=0.0), Landmark(x=0.032771553844213486, y=-0.04408058896660805, z=-0.01757468283176422, visibility=0.0, presence=0.0), Landmark(x=0.049685943871736526, y=-0.05841954052448273, z=-0.02932543307542801, visibility=0.0, presence=0.0), Landmark(x=-0.007693214807659388, y=-0.006966201588511467, z=-0.006752306595444679, visibility=0.0, presence=0.0), Landmark(x=0.006253378931432962, y=-0.022370167076587677, z=-0.01619459129869938, visibility=0.0, presence=0.0), Landmark(x=0.0151065057143569, y=-0.036263976246118546, z=-0.02903265878558159, visibility=0.0, presence=0.0), Landmark(x=0.02835453860461712, y=-0.04629375413060188, z=-0.042412154376506805, visibility=0.0, presence=0.0), Landmark(x=-0.02575833536684513, y=-0.007568996865302324, z=-0.010071517899632454, visibility=0.0, presence=0.0), Landmark(x=-0.015425238758325577, y=-0.01170345302671194, z=-0.01610421948134899, visibility=0.0, presence=0.0), Landmark(x=-0.007979409769177437, y=-0.0152335399761796, z=-0.01949174888432026, visibility=0.0, presence=0.0), Landmark(x=-0.0012600745540112257, y=-0.021795958280563354, z=-0.02509627863764763, visibility=0.0, presence=0.0)]])
Results: HandLandmarkerResult(handedness=[[Category(index=1, score=0.9619948267936707, display_name='Left', category_name='Left')], [Category(index=0, score=0.9832279086112976, display_name='Right', category_name='Right')]], hand_landmarks=[[NormalizedLandmark(x=0.9114580154418945, y=0.8317136764526367, z=3.631562606187799e-07, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.8281804323196411, y=0.8003242015838623, z=-0.03158485144376755, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7568744421005249, y=0.7130885720252991, z=-0.04700196161866188, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7064338326454163, y=0.6207111477851868, z=-0.060605067759752274, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.6648060083389282, y=0.5355400443077087, z=-0.07313083112239838, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7674248814582825, y=0.5176600217819214, z=-0.015423285774886608, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7208313345909119, y=0.39334356784820557, z=-0.040716372430324554, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.6928837299346924, y=0.3156956434249878, z=-0.06402517110109329, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.6698815226554871, y=0.23987478017807007, z=-0.08227209746837616, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.8124094009399414, y=0.4683836102485657, z=-0.020733734592795372, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7728726863861084, y=0.32183465361595154, z=-0.04270986095070839, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7445459961891174, y=0.2307755947113037, z=-0.06533423811197281, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7162328958511353, y=0.14874157309532166, z=-0.08269862085580826, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.8615880608558655, y=0.4569408893585205, z=-0.031729526817798615, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.8374291658401489, y=0.3028833270072937, z=-0.056876301765441895, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.8186533451080322, y=0.2025136947631836, z=-0.0747988373041153, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.7961375117301941, y=0.10991370677947998, z=-0.08776382356882095, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.9145758748054504, y=0.47611257433891296, z=-0.04573838785290718, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.9100103378295898, y=0.35329440236091614, z=-0.06949017941951752, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.9024780988693237, y=0.2689207196235657, z=-0.08016742020845413, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.8901687264442444, y=0.18955299258232117, z=-0.08736441284418106, visibility=0.0, presence=0.0)], [NormalizedLandmark(x=0.10323871672153473, y=0.8913110494613647, z=5.63255582619604e-07, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.17783355712890625, y=0.8737027645111084, z=-0.03746476769447327, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.24344411492347717, y=0.7932060956954956, z=-0.05261756852269173, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.28658047318458557, y=0.6981106996536255, z=-0.06483276188373566, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.3276559114456177, y=0.6276339292526245, z=-0.07681668549776077, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.21949146687984467, y=0.6015211939811707, z=-0.027528051286935806, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2590125799179077, y=0.48148858547210693, z=-0.05224766209721565, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2807369828224182, y=0.4003559350967407, z=-0.07248258590698242, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.29855403304100037, y=0.32697969675064087, z=-0.08746722340583801, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.17742104828357697, y=0.5650219321250916, z=-0.02685764990746975, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.2103123664855957, y=0.42644304037094116, z=-0.04947016015648842, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.23225486278533936, y=0.3322276771068573, z=-0.0699230432510376, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.25045982003211975, y=0.24722042679786682, z=-0.08487964421510696, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.13253644108772278, y=0.563854992389679, z=-0.03124394081532955, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.14835096895694733, y=0.4266416132450104, z=-0.055143170058727264, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.16267329454421997, y=0.3335299789905548, z=-0.07315940409898758, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.1786344051361084, y=0.24887406826019287, z=-0.08542512357234955, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.08447978645563126, y=0.5906391143798828, z=-0.039162591099739075, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.08683500438928604, y=0.4838687479496002, z=-0.06330522894859314, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.09292081743478775, y=0.4100114703178406, z=-0.07616809010505676, visibility=0.0, presence=0.0), NormalizedLandmark(x=0.1030198410153389, y=0.33794456720352173, z=-0.0841997042298317, visibility=0.0, presence=0.0)]], hand_world_landmarks=[[Landmark(x=0.038300443440675735, y=0.08828534930944443, z=-0.0009004240855574608, visibility=0.0, presence=0.0), Landmark(x=0.0020308084785938263, y=0.07518158107995987, z=-0.009424114599823952, visibility=0.0, presence=0.0), Landmark(x=-0.021937720477581024, y=0.05726871266961098, z=-0.018497927114367485, visibility=0.0, presence=0.0), Landmark(x=-0.04664328694343567, y=0.03409842029213905, z=-0.02963862754404545, visibility=0.0, presence=0.0), Landmark(x=-0.06726647913455963, y=0.009087804704904556, z=-0.03402604162693024, visibility=0.0, presence=0.0), Landmark(x=-0.02779253013432026, y=0.010300857946276665, z=0.004488249309360981, visibility=0.0, presence=0.0), Landmark(x=-0.04193728789687157, y=-0.016401298344135284, z=-0.0037242404650896788, visibility=0.0, presence=0.0), Landmark(x=-0.05180516093969345, y=-0.032988291233778, z=-0.012372092343866825, visibility=0.0, presence=0.0), Landmark(x=-0.06335443258285522, y=-0.04418306052684784, z=-0.03720540180802345, visibility=0.0, presence=0.0), Landmark(x=-0.005719984881579876, y=-0.0025133721064776182, z=0.0065124365501105785, visibility=0.0, presence=0.0), Landmark(x=-0.020325863733887672, y=-0.03821277990937233, z=-0.0019100565696135163, visibility=0.0, presence=0.0), Landmark(x=-0.03504518046975136, y=-0.05449981987476349, z=-0.021408863365650177, visibility=0.0, presence=0.0), Landmark(x=-0.048420798033475876, y=-0.06894008070230484, z=-0.04467358812689781, visibility=0.0, presence=0.0), Landmark(x=0.017867926508188248, y=-0.008717098273336887, z=-0.002156527480110526, visibility=0.0, presence=0.0), Landmark(x=0.006696098484098911, y=-0.03955528885126114, z=-0.008169344626367092, visibility=0.0, presence=0.0), Landmark(x=-0.003511205315589905, y=-0.059369802474975586, z=-0.02349608950316906, visibility=0.0, presence=0.0), Landmark(x=-0.015739070251584053, y=-0.07845880836248398, z=-0.04119573161005974, visibility=0.0, presence=0.0), Landmark(x=0.03620791435241699, y=0.0005869753658771515, z=-0.011699504218995571, visibility=0.0, presence=0.0), Landmark(x=0.035554438829422, y=-0.025655727833509445, z=-0.012244879268109798, visibility=0.0, presence=0.0), Landmark(x=0.03155648708343506, y=-0.04632081091403961, z=-0.021450893953442574, visibility=0.0, presence=0.0), Landmark(x=0.021454039961099625, y=-0.060298532247543335, z=-0.036836668848991394, visibility=0.0, presence=0.0)], [Landmark(x=-0.035620179027318954, y=0.08845257014036179, z=0.011462261900305748, visibility=0.0, presence=0.0), Landmark(x=0.003713401034474373, y=0.07290036231279373, z=-0.006980505306273699, visibility=0.0, presence=0.0), Landmark(x=0.030966103076934814, y=0.05634213238954544, z=-0.015278637409210205, visibility=0.0, presence=0.0), Landmark(x=0.05384887382388115, y=0.03263334929943085, z=-0.031810201704502106, visibility=0.0, presence=0.0), Landmark(x=0.07073758542537689, y=0.008916310966014862, z=-0.031881313771009445, visibility=0.0, presence=0.0), Landmark(x=0.027808906510472298, y=0.006670860107988119, z=0.0022964882664382458, visibility=0.0, presence=0.0), Landmark(x=0.04119139909744263, y=-0.01973508484661579, z=-0.006672924384474754, visibility=0.0, presence=0.0), Landmark(x=0.049276188015937805, y=-0.039173126220703125, z=-0.01518058218061924, visibility=0.0, presence=0.0), Landmark(x=0.056355707347393036, y=-0.05282002314925194, z=-0.04362470656633377, visibility=0.0, presence=0.0), Landmark(x=0.0028192950412631035, y=-0.004832922481000423, z=0.006432909984141588, visibility=0.0, presence=0.0), Landmark(x=0.01820867694914341, y=-0.040257230401039124, z=-0.0029196697287261486, visibility=0.0, presence=0.0), Landmark(x=0.025075165554881096, y=-0.06052350252866745, z=-0.025275615975260735, visibility=0.0, presence=0.0), Landmark(x=0.03523411229252815, y=-0.07988221943378448, z=-0.04755321890115738, visibility=0.0, presence=0.0), Landmark(x=-0.017895778641104698, y=-0.006335671991109848, z=-0.0007038914482109249, visibility=0.0, presence=0.0), Landmark(x=-0.010874071158468723, y=-0.03750987350940704, z=-0.010630356147885323, visibility=0.0, presence=0.0), Landmark(x=-0.0023867953568696976, y=-0.05689211189746857, z=-0.028073037043213844, visibility=0.0, presence=0.0), Landmark(x=0.004849070683121681, y=-0.07674262672662735, z=-0.051419131457805634, visibility=0.0, presence=0.0), Landmark(x=-0.039336275309324265, y=0.0035696420818567276, z=-0.007073987741023302, visibility=0.0, presence=0.0), Landmark(x=-0.038331884890794754, y=-0.019880766049027443, z=-0.010122357867658138, visibility=0.0, presence=0.0), Landmark(x=-0.03368913009762764, y=-0.040648944675922394, z=-0.019004346802830696, visibility=0.0, presence=0.0), Landmark(x=-0.0281426552683115, y=-0.056041181087493896, z=-0.03926064446568489, visibility=0.0, presence=0.0)]])
"""
options = hand_landmarker_options(
    base_options = Base_options(model_asset_path = model_path),
    num_hands = 2,
    running_mode = vision_running_mode.LIVE_STREAM,
    result_callback = print_result
)
detector = hand_landmarker.create_from_options(options)
while cam:
    # bool is whether or not a frame was captured. 
    # frame is the numpy array
    bool, frame = cam.read()

    # inverses the frames to mirror what you see irl
    flipped_frame = cv.flip(frame, 1)
    timestamp_msec = int(cam.get(0))    
    rgb = cv.cvtColor(flipped_frame,4)
    mp_image = mp.Image(image_format=mp.ImageFormat.SRGB, data=rgb)
    detection = detector.detect_async(mp_image, timestamp_msec)
    cv.imshow("face detector 9000",flipped_frame)
   # print(latest_results)
    if cv.waitKey(1) == ord("q"):
        break

    #[
    # [Category(index=1, score=0.9256862998008728, display_name='Left', category_name='Left')], 
    # [Category(index=0, score=0.7756921052932739, display_name='Right', category_name='Right')]
    #]

    # 3 nested lists:
    # [-1]: [[Category(index=1, score=0.5256191492080688, display_name='Left', category_name='Left')]]
    # [-1][-1]:[Category(index=1, score=0.5256191492080688, display_name='Left', category_name='Left')]
    # [-1][-1][-1]: Left
    if latest_results[-1]:
        last_result = latest_results[-1]
        if len(last_result) == 2:
            print("Two Hands")
        elif len(last_result) == 1:
            hand_1 = last_result[-1][-1].display_name
            if hand_1 == "Left":
                print("Right")
            elif hand_1 == "Right":
                print("Left")

cam.release()
cv.destroyAllWindows()